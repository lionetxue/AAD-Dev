<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>Photo Edit App</title>

<link rel="stylesheet" type="text/css" href="css/picedit.css" />
<!--<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />-->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
</head>
<body>
<div id="thebox" class="picedit_box">
	<!-- Picedit popup form -->
	<div class="messagepop pop">
		<form method="post" id="new_message" action="/messages">
			<div class="close cross"><i class="fa fa-times" aria-hidden="true"></i></div>
			<p>Enter your email to unlock the secrete sticker and download your profile photos with all stickers in one zipfile!</p>
			<p>We are committed to keeping your e-mail address confidential. We collect user emails to improve user experience for Cornell alumni site.</p>
			<p><label for="email">Your email</label><input type="text" size="30" name="email" id="email" placeholder="me@example.com"/></p>
			<p><input class="submitBtn" type="submit" value="Get My ZipFile" id="message_submit"/> or <a class="close" href="/"> Cancel</a></p>
		</form>
		<h4 id="result"></h4>
	</div>
	<!-- Picedit canvas element -->
	<div class="picedit_canvas_box">
		<div class="picedit_action_btns active">
			<div class="center">Take a selfie or upload a photo by dragging/browsing</div>
			<div class="picedit_control ico-picedit-picture" data-action="load_image"></div>
			<div class="picedit_control ico-picedit-camera" data-action="camera_open"></div>
		</div>
		<div id="canvas-container" class="picedit_canvas">
			<canvas id="canvas" width="400px" height="400px"> This text is displayed if your browser does not support HTML5 Canvas</canvas>
		</div>
		<div class="picedit_video">
			<video autoplay></video>
			<div class="picedit_video_controls">
				<span class="picedit_control  ico-picedit-checkmark" data-action="take_photo"></span>
				<span class="picedit_control  ico-picedit-close" data-action="camera_close"></span>
			</div>
		</div>
		<div class="picedit_drag_resize">
			<div class="picedit_drag_resize_canvas"></div>
			<div class="picedit_drag_resize_box">
				<div class="picedit_drag_resize_box_corner_wrap">
					<div class="picedit_drag_resize_box_corner"></div>
				</div>
				<div class="picedit_drag_resize_box_elements">
					<span class="picedit_control  ico-picedit-checkmark" data-action="crop_image"></span>
					<span class="picedit_control  ico-picedit-close" data-action="crop_close"></span>
				</div>
			</div>
		</div>
	</div>
	<!--Stickers-->
	<div id="stickers">
		<h2>My Cornell Profile Stickers</h2>
		<p>Click on a sticker to place it on your profile picture.</p>
		<span class="picedit_control picedit_sticker" title="Sticker" ><img  id="sticker_1" src="img/sticker_1.png" width="80" height="80"/></span>
		<span class="picedit_control picedit_sticker" title="Sticker" ><img  id="sticker_2" src="img/sticker_2.png" width="80" height="80"/></span>
		<span class="picedit_control picedit_sticker" title="Sticker" ><img  id="sticker_3" src="img/sticker_3.png" width="80" height="80"/></span>
		<span class="picedit_control picedit_sticker" title="Sticker" ><img  id="sticker_4" src="img/sticker_4.png" width="80" height="80"/></span>
		<span class="picedit_control picedit_sticker" title="Sticker" ><img  id="sticker_5" src="img/sticker_5.png" width="80" height="80"/></span>
	</div>
	<!--Picedit message-->
	<div class="picedit_message">
		<span class="picedit_control ico-picedit-close" data-action="hide_messagebox"></span>
		<div></div>
	</div>
	<!-- Picedit navigation -->
	<div class="picedit_nav_box">
		<!--<div class="picedit_pos_elements"></div>-->
		<ul class="picedit_nav_elements">
			<!-- Picedit button element begin -->
			<li class="picedit_element"><span class="picedit_control  fa fa-crop" title="Crop" data-action="crop_open"><b> Crop</b></span> </li>
			<!-- Picedit button element end -->
			<!-- Picedit button element begin -->
			<li class="picedit_element"> <span class="picedit_control  fa fa-repeat" title="Rotate" data-action="rotate_cw"><b> Rotate</b></span>
<!--					<ul class="picedit_control_menu picedit_tooltip">
					&lt;!&ndash;<div class="picedit_control_menu_container picedit_tooltip picedit_elm_1">&ndash;&gt;
						<li> <span>90&deg; CW</span> <span class="picedit_control picedit_action fa fa-repeat" data-action="rotate_cw"></span> </li>
						<li> <span>90&deg; CCW</span> <span class="picedit_control picedit_action fa fa-undo" data-action="rotate_ccw"></span> </li>
					&lt;!&ndash;</div>&ndash;&gt;
					</ul>-->
			</li>
			<!-- Picedit button element end -->
			<!-- Picedit button element begin -->
			<li class="picedit_element"><a id="downloadImg" class="picedit_control picedit_action fa fa-download" title="Download" onclick="$('#downloadImg').attr('href', canvas.toDataURL());" download="Cornell_Profile.png" href="#" target="_blank"><b> Download</b></a> </li>
			<!-- Picedit button element end -->
			<!-- Picedit button element begin -->
			<li class="picedit_element"><span id="downloadZip" class="picedit_control picedit_action fa fa-file-archive-o" title="Download ZipFile"><b> ZipFile</b></span> </li>
			<!-- Picedit button element end -->
			<!-- Picedit button element begin -->
			<li class="picedit_element"><span class="picedit_control fa fa-share-square-o" title="Share"><b> Share</b></span>
				<!-- Floating Share Buttons Container -->
				<div class="picedit_control_menu socialfloat">
					<!-- Facebook Share Button -->
					<a class="fbtn share facebook" href="http://www.facebook.com/sharer/sharer.php?u=http://alumni.cornell.edu/"><i class="fa fa-facebook"></i></a>
					<!-- Google Plus Share Button -->
					<a class="fbtn share gplus" href="#"><i class="fa fa-google-plus"></i></a>
					<!-- Twitter Share Button -->
					<a class="fbtn share twitter" href="#"><i class="fa fa-twitter"></i></a>
					<!-- LinkedIn Share Button -->
					<a class="fbtn share linkedin" href="#"><i class="fa fa-linkedin"></i></a>
					<!-- Email Share Button -->
					<a class="fbtn share email" href="#"><i class="fa fa-envelope"></i></a>
				</div>
		    </li>
			<!-- Picedit button element end -->
			<!-- Picedit button element begin -->
			<!--<div class="picedit_element"> <span class="picedit_control ico-picedit-arrow-maximise" title="Resize"></span>
				<div class="picedit_control_menu">
					<div class="picedit_control_menu_container picedit_tooltip picedit_elm_2">
						<label> <span>Width (px)</span>
							<input type="text" class="picedit_input" data-variable="resize_width" value="0">
						</label>
						<label> <span>Height (px)</span>
							<input type="text" class="picedit_input" data-variable="resize_height" value="0">
						</label>
					</div>
				</div>
			</div>-->
			<!-- Picedit button element end -->
		</ul>
	</div>
</div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="js/FileSaver.min.js"></script>
<script type="text/javascript" src="js/jszip.min.js"></script>
<script type="application/javascript" src="js/fabric.js"></script>
<script type="text/javascript" src="js/picedit.js"></script>
<script type="text/javascript">
	//Lin: form
	function deselect(e) {
		$('.pop').slideFadeToggle(function() {
			e.removeClass('selected');
			$("#result").text('');
		});
	}
	function validateEmail(email) {
		var re = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
		return re.test(email);
	}

	$(function() {
		// Document is ready
		$('#thebox').picEdit();

		//popup form to collect user email
		$('#downloadZip').on('click', function() {
			if($(this).hasClass('selected')) {
				deselect($(this));
			} else {
				$(this).addClass('selected');
				$('.pop').slideFadeToggle();
			}
			return false;
		});

		$('.close').on('click', function() {
			deselect($('#downloadZip'));
			$("#result").text('');
			return false;
		});

/* 		//test JSZip
		var zip = new JSZip();
       // create a file
		zip.file("Hello.txt", "Hello World\n");
		// create a folder
		var img = zip.folder("images");
		var imgData = "R0lGODdhBQAFAIACAAAAAP/eACwAAAAABQAFAAACCIwPkWerClIBADs=";
		img.file("smile.gif", imgData, {base64: true});*/

		function bindEvent(el, eventName, eventHandler) {
			if (el.addEventListener){
				// standard way
				el.addEventListener(eventName, eventHandler, false);
			} else if (el.attachEvent){
				// old IE
				el.attachEvent('on'+eventName, eventHandler);
			}
		}

		// Blob
		var blobLink = document.getElementById('message_submit');
		if (JSZip.support.blob) {
			function downloadWithBlob(e) {
				//Don't submit form yet
				e.preventDefault();
				//validate email first
				var email = $("#email").val();
				if (validateEmail(email)) {
					//prepare zipfile
					var zip = new JSZip();
					var canvas1 = document.getElementById('canvas').fabric;
					//Remove existing sticker if any
					var exSticker = canvas1.item(1);
					if (exSticker) {
						canvas1.remove(exSticker);
					}
					// Get all img elements
					var stickers = document.getElementsByTagName('img');
					for (var i=0; i<stickers.length; i++) {
						var stickerID = stickers[i].id;
						if (sticker) {
							canvas1.remove(sticker);
						}
						var imgElement = document.getElementById(stickerID);
						var sticker = new fabric.Image(imgElement, {
							left: 20,
							top: 300,
							lockUniScaling: true,
							hasControls: false,
							hasBorders: false
						});
						//Add new sticker to canvas
						canvas1.insertAt(sticker,1, false);
						var savable = new Image();
						savable.src = canvas1.toDataURL();
						var imageData = savable.src.substr(savable.src.indexOf(',')+1);
						zip.file("profile_"+ i +".png", imageData, {base64: true});
					}

					zip.generateAsync({type:"blob"}).then(function (blob) {
						saveAs(blob, "example.zip");
					}, function (err) {
						blobLink.innerHTML += " " + err;
					});
				}
				else {
					$("#result").text("You must enter a valid email address!").css("color", "red");
				}
				this._formsubmit(); //now submit the form
				return false;
			}
			bindEvent(blobLink, 'click', downloadWithBlob);
		} else {
			blobLink.innerHTML += " (not supported on this browser)";
		}
/*		// data URI
		function downloadWithDataURI() {
			zip.generateAsync({type:"base64"}).then(function (base64) {
				window.location = "data:application/zip;base64," + base64;
			}, function (err) {
				// shouldn't happen with a base64...
			});
		}
		var dataUriLink = document.getElementById('message_submit');
		bindEvent(dataUriLink, 'click', downloadWithDataURI);*/

		//Social Media share popup window
		$('.share').click(function() {
			var NWin = window.open($(this).prop('href'), '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=300,width=600');
			if (window.focus)
			{
				NWin.focus();
			}
			return false;
		});


	});
//Lin: form
	$.fn.slideFadeToggle = function(easing, callback) {
		return this.animate({ opacity: 'toggle', height: 'toggle' }, 'fast', easing, callback);
	};

</script>
</body>
</html>