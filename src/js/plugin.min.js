/**
 * Created by lx58 on 12/9/2016.
 */
/*
 *  Project: PhotoSticker plugin based on PicEdit by Andy V. and fabric.js
 *  Description: Allows user to take a selfie or upload a photo with tools to edit the image on the front-end and apply stickers to it
 *               The user can then download the profile, download a Zip file for all stickers and share on social media.
 *  Author: Lin Xue
 *  License: MIT
 */
!function(a,b,c,d){"use strict";function g(b,c){this.element=b,this.options=a.extend({},f,c),this._defaults=f,this._name=e,this._image=!1,this._scale=!1,this._sticker=null,this._filename="",this._variables={},this.init()}var e="picEdit",f={imageUpdated:function(a){},formSubmitted:function(a){},redirectUrl:!1,maxWidth:400,maxHeight:400,aspectRatio:!0,defaultImage:!1};g.prototype={init:function(){function f(a){if(a||a.length){var b=a[0];d._filename||(d._filename=b.name);var c=new FileReader;c.onload=function(a){d._create_image_with_datasrc(a.target.result,!1,b)},c.readAsDataURL(b)}}var d=this,e=a(this.element).prop("type");if("file"==e?this._fileinput=a(this.element):(a(this.element).after('<input type="file" style="display:none" accept="image/*">'),this._fileinput=a(this.element).next("input")),this._canvas=new fabric.Canvas("canvas"),c.getElementById("canvas").fabric=this._canvas,this._canvas.preserveObjectStacking=!0,this._ctx=this._canvas.getContext("2d"),this._videobox=a(this.element).find(".picedit_video"),this._videostream,this._messagebox=a(this.element).find(".picedit_message"),this._messagetimeout=!1,this._mainbuttons=a(this.element).find(".picedit_action_btns"),this._viewport={width:0,height:0},this._cropping={is_dragging:!1,is_resizing:!1,left:0,top:0,width:0,height:0,cropbox:a(this.element).find(".picedit_drag_resize"),cropframe:a(this.element).find(".picedit_drag_resize_box")},a(this.element).find(".picedit_canvas_box").on("drop",function(b){b.preventDefault(),a(this).removeClass("dragging");var c=(b.dataTransfer||b.originalEvent.dataTransfer).files;f(c)}).on("dragover",function(b){b.preventDefault(),a(this).addClass("dragging")}).on("dragleave",function(b){b.preventDefault(),a(this).removeClass("dragging")}),a(this._fileinput).on("change",function(){f(this.files)}),!b.Clipboard){var g=a(c.createElement("div"));g.prop("contenteditable","true").css({position:"absolute",left:-999,width:0,height:0,overflow:"hidden",outline:0,opacity:0}),a(c.body).prepend(g)}a(c).on("paste",function(a){var c,b=(a.clipboardData||a.originalEvent.clipboardData).items;if(b){for(var e=0;e<b.length;e++)0===b[e].type.indexOf("image")&&(c=b[e].getAsFile());if(c){var f=new FileReader;f.onload=function(a){d._create_image_with_datasrc(a.target.result)},f.readAsDataURL(c)}}else g.get(0).focus(),g.on("DOMSubtreeModified",function(){var a=g.children().last().get(0);g.html(""),a&&("IMG"===a.tagName&&"data:"==a.src.substr(0,5)?d._create_image_with_datasrc(a.src):"IMG"===a.tagName&&"http"==a.src.substr(0,4)&&d._create_image_with_datasrc(a.src,!1,!1,!0))})}),this._theformdata=!1,this._theform=a(this.inputelement).parents("form"),this._theform.length&&this._theform.on("submit",function(){return d._formsubmit()}),this._bindControlButtons(),this._bindInputVariables(),this._bindSelectionDrag(),this._variables.prev_pos=!1,this.options.defaultImage&&d.set_default_image(this.options.defaultImage),a(this.element).find(".sticker").click(function(a){if(!d._image)return d._hideAllNav(1);var b=c.getElementById(a.target.id);d._sticker?d._sticker.setElement(b):d._sticker=new fabric.Image(b,{left:20,top:270,scaleX:1.5,scaleY:1.5,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),d._canvas.insertAt(d._sticker,1,!1)}),this._canvas.on("object:moving",function(a){var b=a.target;0===d._canvas.getObjects().indexOf(b)&&(b.setCoords(),(b.getBoundingRect().top>0||b.getBoundingRect().left>0)&&(b.top=Math.min(b.top,b.top-b.getBoundingRect().top),b.left=Math.min(b.left,b.left-b.getBoundingRect().left)),(b.getBoundingRect().top+b.getBoundingRect().height<b.canvas.height||b.getBoundingRect().left+b.getBoundingRect().width<b.canvas.width)&&(b.top=Math.max(b.top,b.canvas.height-b.getBoundingRect().height+b.top-b.getBoundingRect().top),b.left=Math.max(b.left,b.canvas.width-b.getBoundingRect().width+b.left-b.getBoundingRect().left)))})},check_browser_capabilities:function(){return 0!=!!b.CanvasRenderingContext2D&&!!b.FileReader},set_default_image:function(a){this._create_image_with_datasrc(a,!1,!1,!0)},hide_messagebox:function(){var a=this._messagebox;a.removeClass("active no_close_button"),setTimeout(function(){a.children("div").html("")},200)},set_loading:function(a){return a&&1==a?this.set_messagebox("Working...",!1,!1):this.set_messagebox("Please Wait...",!1,!1)},set_messagebox:function(a,b,c){b="undefined"!=typeof b?b:3e3,c="undefined"==typeof c||c;var d="active";if(c||(d+=" no_close_button"),b){clearTimeout(this._messagetimeout);var e=this;this._messagetimeout=setTimeout(function(){e.hide_messagebox()},b)}return this._messagebox.addClass(d).children("div").html(a)},toggle_button:function(b){if(a(b).hasClass("active")){var c=!1;a(b).removeClass("active")}else{var c=!0;a(b).siblings().removeClass("active"),a(b).addClass("active")}var d=a(b).data("variable");if(d){var e=a(b).data("value");e||(e=a(b).val()),e&&c&&(c=e),this._setVariable(d,c)}},load_image:function(){this._fileinput.click()},rotate_ccw:function(){if(!this._image)return this._hideAllNav(1);var a=this;this.set_loading(1).delay(200).promise().done(function(){a._doRotation(-90),a._resizeViewport(),a.hide_messagebox()}),this._hideAllNav()},rotate_cw:function(){if(!this._image)return this._hideAllNav(1);var a=this;a._doRotation(90),this._hideAllNav()},camera_open:function(){var a,b=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(!b)return this.set_messagebox("Sorry, your browser doesn't support WebRTC!");var c=this;(a=b.bind(navigator))({audio:!1,video:!0},function(a){var b=c._videobox.find("video")[0];b.src=URL.createObjectURL(a),b.onloadedmetadata=function(){b.videoWidth&&b.videoHeight&&(c._image||(c._image={}),c._image.width=b.videoWidth,c._image.height=b.videoHeight,c._resizeViewport())},c._videobox.addClass("active"),c._videostream=a},function(a){return c.set_messagebox("No video source detected! Please allow camera access!")})},camera_close:function(){this._videobox.removeClass("active"),this._videostream.getVideoTracks()[0].stop()},take_photo:function(){var a=this,b=this._videobox.find("video")[0],d=c.createElement("canvas"),e=d.getContext("2d");d.width=b.clientWidth,d.height=b.clientHeight,e.drawImage(b,0,0,d.width,d.height),this._create_image_with_datasrc(d.toDataURL("image/png"),function(){a._videobox.removeClass("active"),a._videostream.getVideoTracks()[0].stop()})},crop_image:function(a){var b=this._calculateCropWindow(),d=this,e=d._canvas.item(0),f=b.left-e.left/d._scale,g=b.top-e.top/d._scale;d._scale>1&&(f=(b.left-e.left)/d._scale,g=(b.top-e.top)/d._scale),this.set_loading(1).delay(200).promise().done(function(){var a=c.createElement("canvas"),e=a.getContext("2d");a.width=b.width,a.height=b.height,e.drawImage(d._image,f,g,b.width,b.height,0,0,b.width,b.height),d._create_image_with_datasrc(a.toDataURL("image/png"),function(){d.hide_messagebox()})}),this.crop_close()},crop_open:function(){return this._image?(this._cropping.cropbox.addClass("active"),void this._hideAllNav()):this._hideAllNav(1)},crop_close:function(){this._cropping.cropbox.removeClass("active")},discard_image:function(){this._ctx.clearRect(0,0,canvas.width,canvas.height),this._image=!1,a(".picedit_action_btns").addClass("active")},_create_image_with_datasrc:function(a,b,d,e){var f=this,g=c.createElement("img");e&&g.setAttribute("crossOrigin","anonymous"),d&&(g.file=d),g.src=a,g.onload=function(){if(e){var a=c.createElement("canvas"),d=a.getContext("2d");a.width=g.width,a.height=g.height,d.drawImage(g,0,0),g.src=a.toDataURL("image/png")}f._image=g,f._resizeViewport(),f._paintCanvas(),f.options.imageUpdated(f._image),f._mainbuttons.removeClass("active"),b&&"function"==typeof b&&b()}},_bindSelectionDrag:function(){var c=this,d=this._cropping.cropframe,e=this._cropping.cropbox.find(".picedit_drag_resize_box_corner_wrap");a(b).on("mousedown touchstart",function(a){var b=a.clientX?a:a.originalEvent.touches[0];c._cropping.x=b.clientX,c._cropping.y=b.clientY,c._cropping.w=d[0].clientWidth,c._cropping.h=d[0].clientHeight,d.on("mousemove touchmove",function(a){a.stopPropagation(),a.preventDefault(),c._cropping.is_dragging=!0,c._cropping.is_resizing||c._selection_drag_movement(a)}),e.on("mousemove touchmove",function(a){a.stopPropagation(),a.preventDefault(),c._cropping.is_resizing=!0,c._selection_resize_movement(a)})}).on("mouseup touchend",function(){c._painter_painting&&c._painter_merge_drawing(),c._cropping.is_dragging=!1,c._cropping.is_resizing=!1,c._variables.prev_pos=!1,d.off("mousemove touchmove"),e.off("mousemove touchmove")})},_selection_resize_movement:function(a){var b=this._cropping.cropframe[0],c=a.clientX?a:a.originalEvent.touches[0];b.style.width=this._cropping.w+c.clientX-this._cropping.x+"px",b.style.height=this._cropping.w+c.clientX-this._cropping.x+"px"},_selection_drag_movement:function(a){var b=this._cropping.cropframe[0],c=a.pageX?a:a.originalEvent.touches[0];this._cropping.cropframe.offset({top:c.pageY-parseInt(b.clientHeight/2,10),left:c.pageX-parseInt(b.clientWidth/2,10)})},_hideAllNav:function(b){b&&1==b&&this.set_messagebox("Open an image or use your camera to make a photo!"),a(this.element).find(".picedit_nav_box").removeClass("active").find(".picedit_element").removeClass("active")},_paintCanvas:function(){var b=this,c=this._canvas.width/this._image.width,d=this._canvas.height/this._image.height,e=Math.max(c,d);b._scale=e,fabric.Image.fromURL(this._image.src,function(a){a.scale(e),a.lockUniScaling=!0,a.hasControls=!1,a.hasBorders=!1,c<d?a.lockMovementY=!0:a.lockMovementX=!0,b._canvas.insertAt(a,0,!0).deactivateAll().renderAll()}),a(this.element).find(".picedit_canvas").css("display","block")},_calculateCropWindow:function(){var a=this._viewport,b=this._cropping.cropframe[0],c={width:this._image.width,height:this._image.height},d={width:b.clientWidth,height:b.clientHeight,top:b.offsetTop>0?b.offsetTop:.1,left:b.offsetLeft>0?b.offsetLeft:.1};d.width+d.left>a.width&&(d.width=a.width-d.left),d.height+d.top>a.height&&(d.height=a.height-d.top);var e=d.width/a.width,f=d.height/a.height,g={width:parseInt(c.width*e,10),height:parseInt(c.height*f,10)},h=d.top/a.height,i=d.left/a.width;return g.top=parseInt(c.height*h,10),g.left=parseInt(c.width*i,10),g},_doRotation:function(a){var b=this._canvas.item(0),c=b.getAngle(),d=new fabric.Point(this._canvas.width/2,this._canvas.height/2),e=fabric.util.degreesToRadians(a),f=new fabric.Point(b.left,b.top),g=fabric.util.rotatePoint(f,d,e);b.setAngle(c+a),b.top=g.y,b.left=g.x,this._canvas.renderAll()},_resizeViewport:function(){var a=this._image,b={width:a.width,height:a.height};if("auto"!=this.options.maxWidth&&a.width>this.options.maxWidth&&(b.width=this.options.maxWidth),"auto"!=this.options.maxHeight&&a.height>this.options.maxHeight&&(b.height=this.options.maxHeight),this.options.aspectRatio){var c=a.width,d=a.height,e=c/d;c>d?d>b.height&&(e=c/d,b.height=parseInt(b.height,10),b.width=parseInt(b.height*e,10)):c>b.width&&(b.width=parseInt(b.width,10),b.height=parseInt(b.width/e,10))}this._viewport=b,this._setVariable("resize_width",a.width),this._setVariable("resize_height",a.height)},_bindControlButtons:function(){var b=this;a(this.element).find(".picedit_control").bind("click",function(){var c=a(this).data("action");c?b[c](this):a(this).hasClass("picedit_action")&&(a(this).parent(".picedit_element").toggleClass("active").siblings(".picedit_element").removeClass("active"),a(this).parent(".picedit_element").hasClass("active")?a(this).closest(".picedit_nav_box").addClass("active"):a(this).closest(".picedit_nav_box").removeClass("active"))})},_bindInputVariables:function(){var b=this;a(this.element).find(".picedit_input").bind("change keypress paste input",function(){var c=a(this).data("variable");if(c){var d=a(this).val();b._variables[c]=d}if(("resize_width"==c||"resize_height"==c)&&b._variables.resize_proportions){var e=b._image.width/b._image.height;"resize_width"==c?b._setVariable("resize_height",parseInt(d/e,10)):b._setVariable("resize_width",parseInt(d*e,10))}})},_setVariable:function(b,c){this._variables[b]=c,a(this.element).find('[data-variable="'+b+'"]').val(c)}},a.fn[e]=function(b){var c=arguments;if(b===d||"object"==typeof b)return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new g(this,b))});if("string"==typeof b&&"_"!==b[0]&&"init"!==b){var f;return this.each(function(){var d=a.data(this,"plugin_"+e);d instanceof g&&"function"==typeof d[b]&&(f=d[b].apply(d,Array.prototype.slice.call(c,1))),"destroy"===b&&a.data(this,"plugin_"+e,null)}),f!==d?f:this}}}(jQuery,window,document);