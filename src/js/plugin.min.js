/**
 * Created by lx58 on 10/25/2016.
 */
/*
 *  Project: PhotoSticker plugin based on PicEdit by Andy V. and fabric.js
 *  Description: Allows user to take a selfie or upload a photo with tools to edit the image on the front-end and apply stickers to it
 *               The user can then download the profile, download a Zip file for all stickers and share on social media.
 *  Author: Lin Xue
 *  License: MIT
 */
!function(t,e,i,a){"use strict";function n(e,i){this.element=e,this.options=t.extend({},o,i),this._defaults=o,this._name=s,this._image=!1,this._scale=!1,this._sticker=null,this._filename="",this._variables={},this.init()}var s="picEdit",o={imageUpdated:function(t){},formSubmitted:function(t){},redirectUrl:!1,maxWidth:400,maxHeight:400,aspectRatio:!0,defaultImage:!1};n.prototype={init:function(){function a(t){if(t||t.length){var e=t[0];n._filename||(n._filename=e.name);var i=new FileReader;i.onload=function(t){n._create_image_with_datasrc(t.target.result,!1,e)},i.readAsDataURL(e)}}var n=this,s=t(this.element).prop("type");if("file"==s?this._fileinput=t(this.element):(t(this.element).after('<input type="file" style="display:none" accept="image/*">'),this._fileinput=t(this.element).next("input")),this._canvas=new fabric.Canvas("canvas"),i.getElementById("canvas").fabric=this._canvas,this._canvas.preserveObjectStacking=!0,this._ctx=this._canvas.getContext("2d"),this._videobox=t(this.element).find(".picedit_video"),this._videostream,this._messagebox=t(this.element).find(".picedit_message"),this._messagetimeout=!1,this._mainbuttons=t(this.element).find(".picedit_action_btns"),this._viewport={width:0,height:0},this._cropping={is_dragging:!1,is_resizing:!1,left:0,top:0,width:0,height:0,cropbox:t(this.element).find(".picedit_drag_resize"),cropframe:t(this.element).find(".picedit_drag_resize_box")},t(this.element).find(".picedit_canvas_box").on("drop",function(e){e.preventDefault(),t(this).removeClass("dragging");var i=(e.dataTransfer||e.originalEvent.dataTransfer).files;a(i)}).on("dragover",function(e){e.preventDefault(),t(this).addClass("dragging")}).on("dragleave",function(e){e.preventDefault(),t(this).removeClass("dragging")}),t(this._fileinput).on("change",function(){a(this.files)}),!e.Clipboard){var o=t(i.createElement("div"));o.prop("contenteditable","true").css({position:"absolute",left:-999,width:0,height:0,overflow:"hidden",outline:0,opacity:0}),t(i.body).prepend(o)}t(i).on("paste",function(t){var e,i=(t.clipboardData||t.originalEvent.clipboardData).items;if(i){for(var a=0;a<i.length;a++)0===i[a].type.indexOf("image")&&(e=i[a].getAsFile());if(e){var s=new FileReader;s.onload=function(t){n._create_image_with_datasrc(t.target.result)},s.readAsDataURL(e)}}else o.get(0).focus(),o.on("DOMSubtreeModified",function(){var t=o.children().last().get(0);o.html(""),t&&("IMG"===t.tagName&&"data:"==t.src.substr(0,5)?n._create_image_with_datasrc(t.src):"IMG"===t.tagName&&"http"==t.src.substr(0,4)&&n._create_image_with_datasrc(t.src,!1,!1,!0))})}),this._theformdata=!1,this._theform=t(this.inputelement).parents("form"),this._theform.length&&this._theform.on("submit",function(){return n._formsubmit()}),this._bindControlButtons(),this._bindInputVariables(),this._bindSelectionDrag(),this._variables.prev_pos=!1,this.options.defaultImage&&n.set_default_image(this.options.defaultImage),t(this.element).find(".picedit_sticker").on("click",function(t){if(!n._image)return n._hideAllNav(1);var e=i.getElementById(t.target.id);n._sticker?n._sticker.setElement(e):n._sticker=new fabric.Image(e,{left:20,top:300,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),n._canvas.insertAt(n._sticker,1,!1)}),this._canvas.on("object:moving",function(t){var e=t.target;0===n._canvas.getObjects().indexOf(e)&&(e.setCoords(),(e.getBoundingRect().top>0||e.getBoundingRect().left>0)&&(e.top=Math.min(e.top,e.top-e.getBoundingRect().top),e.left=Math.min(e.left,e.left-e.getBoundingRect().left)),(e.getBoundingRect().top+e.getBoundingRect().height<e.canvas.height||e.getBoundingRect().left+e.getBoundingRect().width<e.canvas.width)&&(e.top=Math.max(e.top,e.canvas.height-e.getBoundingRect().height+e.top-e.getBoundingRect().top),e.left=Math.max(e.left,e.canvas.width-e.getBoundingRect().width+e.left-e.getBoundingRect().left)))})},check_browser_capabilities:function(){return 0==!!e.CanvasRenderingContext2D?!1:e.FileReader?!0:!1},set_default_image:function(t){this._create_image_with_datasrc(t,!1,!1,!0)},hide_messagebox:function(){var t=this._messagebox;t.removeClass("active no_close_button"),setTimeout(function(){t.children("div").html("")},200)},set_loading:function(t){return t&&1==t?this.set_messagebox("Working...",!1,!1):this.set_messagebox("Please Wait...",!1,!1)},set_messagebox:function(t,e,i){e="undefined"!=typeof e?e:3e3,i="undefined"!=typeof i?i:!0;var a="active";if(i||(a+=" no_close_button"),e){clearTimeout(this._messagetimeout);var n=this;this._messagetimeout=setTimeout(function(){n.hide_messagebox()},e)}return this._messagebox.addClass(a).children("div").html(t)},toggle_button:function(e){if(t(e).hasClass("active")){var i=!1;t(e).removeClass("active")}else{var i=!0;t(e).siblings().removeClass("active"),t(e).addClass("active")}var a=t(e).data("variable");if(a){var n=t(e).data("value");n||(n=t(e).val()),n&&i&&(i=n),this._setVariable(a,i)}},load_image:function(){this._fileinput.click()},rotate_ccw:function(){if(!this._image)return this._hideAllNav(1);var t=this;this.set_loading(1).delay(200).promise().done(function(){t._doRotation(-90),t._resizeViewport(),t.hide_messagebox()}),this._hideAllNav()},rotate_cw:function(){if(!this._image)return this._hideAllNav(1);var t=this;t._doRotation(90),this._hideAllNav()},camera_open:function(){var t,e=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(!e)return this.set_messagebox("Sorry, your browser doesn't support WebRTC!");var i=this;(t=e.bind(navigator))({audio:!1,video:!0},function(t){var e=i._videobox.find("video")[0];e.src=URL.createObjectURL(t),e.onloadedmetadata=function(){e.videoWidth&&e.videoHeight&&(i._image||(i._image={}),i._image.width=e.videoWidth,i._image.height=e.videoHeight,i._resizeViewport())},i._videobox.addClass("active"),i._videostream=t},function(t){return i.set_messagebox("No video source detected! Please allow camera access!")})},camera_close:function(){this._videobox.removeClass("active"),this._videostream.getVideoTracks()[0].stop()},take_photo:function(){var t=this,e=this._videobox.find("video")[0],a=i.createElement("canvas"),n=a.getContext("2d");a.width=e.clientWidth,a.height=e.clientHeight,n.drawImage(e,0,0,a.width,a.height),this._create_image_with_datasrc(a.toDataURL("image/png"),function(){t._videobox.removeClass("active"),t._videostream.getVideoTracks()[0].stop()})},crop_image:function(){var t=this._calculateCropWindow(),e=this,a=e._canvas.item(0),n=t.left-a.left/e._scale,s=t.top-a.top/e._scale;this.set_loading(1).delay(200).promise().done(function(){var a=i.createElement("canvas"),o=a.getContext("2d");a.width=t.width,a.height=t.height,o.drawImage(e._image,n,s,t.width,t.height,0,0,t.width,t.height),e._create_image_with_datasrc(a.toDataURL("image/png"),function(){e.hide_messagebox()})}),this.crop_close()},crop_open:function(){return this._image?(this._cropping.cropbox.addClass("active"),void this._hideAllNav()):this._hideAllNav(1)},crop_close:function(){this._cropping.cropbox.removeClass("active")},_create_image_with_datasrc:function(t,e,a,n){var s=this,o=i.createElement("img");n&&o.setAttribute("crossOrigin","anonymous"),a&&(o.file=a),o.src=t,o.onload=function(){if(n){var t=i.createElement("canvas"),a=t.getContext("2d");t.width=o.width,t.height=o.height,a.drawImage(o,0,0),o.src=t.toDataURL("image/png")}s._image=o,s._resizeViewport(),s._paintCanvas(),s.options.imageUpdated(s._image),s._mainbuttons.removeClass("active"),e&&"function"==typeof e&&e()}},_bindSelectionDrag:function(){var i=this,a=this._cropping.cropframe,n=this._cropping.cropbox.find(".picedit_drag_resize_box_corner_wrap");t(e).on("mousedown touchstart",function(t){var e=t.clientX?t:t.originalEvent.touches[0];i._cropping.x=e.clientX,i._cropping.y=e.clientY,i._cropping.w=a[0].clientWidth,i._cropping.h=a[0].clientHeight,a.on("mousemove touchmove",function(t){t.stopPropagation(),t.preventDefault(),i._cropping.is_dragging=!0,i._cropping.is_resizing||i._selection_drag_movement(t)}),n.on("mousemove touchmove",function(t){t.stopPropagation(),t.preventDefault(),i._cropping.is_resizing=!0,i._selection_resize_movement(t)})}).on("mouseup touchend",function(){i._painter_painting&&i._painter_merge_drawing(),i._cropping.is_dragging=!1,i._cropping.is_resizing=!1,i._variables.prev_pos=!1,a.off("mousemove touchmove"),n.off("mousemove touchmove")})},_selection_resize_movement:function(t){var e=this._cropping.cropframe[0],i=t.clientX?t:t.originalEvent.touches[0];e.style.width=this._cropping.w+i.clientX-this._cropping.x+"px",e.style.height=this._cropping.w+i.clientX-this._cropping.x+"px"},_selection_drag_movement:function(t){var e=this._cropping.cropframe[0],i=t.pageX?t:t.originalEvent.touches[0];this._cropping.cropframe.offset({top:i.pageY-parseInt(e.clientHeight/2,10),left:i.pageX-parseInt(e.clientWidth/2,10)})},_hideAllNav:function(e){e&&1==e&&this.set_messagebox("Open an image or use your camera to make a photo!"),t(this.element).find(".picedit_nav_box").removeClass("active").find(".picedit_element").removeClass("active")},_paintCanvas:function(){var e=this,i=this._canvas.width/this._image.width,a=this._canvas.height/this._image.height,n=Math.max(i,a);e._scale=n,fabric.Image.fromURL(this._image.src,function(t){t.scale(n),t.lockUniScaling=!0,t.hasControls=!1,t.hasBorders=!1,a>i?t.lockMovementY=!0:t.lockMovementX=!0,e._canvas.insertAt(t,0,!0).deactivateAll().renderAll()}),t(this.element).find(".picedit_canvas").css("display","block")},_calculateCropWindow:function(){var t=this._viewport,e=this._cropping.cropframe[0],i={width:this._image.width,height:this._image.height},a={width:e.clientWidth,height:e.clientHeight,top:e.offsetTop>0?e.offsetTop:.1,left:e.offsetLeft>0?e.offsetLeft:.1};a.width+a.left>t.width&&(a.width=t.width-a.left),a.height+a.top>t.height&&(a.height=t.height-a.top);var n=a.width/t.width,s=a.height/t.height,o={width:parseInt(i.width*n,10),height:parseInt(i.height*s,10)},r=a.top/t.height,h=a.left/t.width;return o.top=parseInt(i.height*r,10),o.left=parseInt(i.width*h,10),o},_doRotation:function(t){var e=this._canvas.item(0),i=e.getAngle(),a=new fabric.Point(this._canvas.width/2,this._canvas.height/2),n=fabric.util.degreesToRadians(t),s=new fabric.Point(e.left,e.top),o=fabric.util.rotatePoint(s,a,n);e.setAngle(i+t),e.top=o.y,e.left=o.x,this._canvas.renderAll()},_resizeViewport:function(){var t=this._image,e={width:t.width,height:t.height};if("auto"!=this.options.maxWidth&&t.width>this.options.maxWidth&&(e.width=this.options.maxWidth),"auto"!=this.options.maxHeight&&t.height>this.options.maxHeight&&(e.height=this.options.maxHeight),this.options.aspectRatio){var i=t.width,a=t.height,n=i/a;i>a?a>e.height&&(n=i/a,e.height=parseInt(e.height,10),e.width=parseInt(e.height*n,10)):i>e.width&&(e.width=parseInt(e.width,10),e.height=parseInt(e.width/n,10))}this._viewport=e,this._setVariable("resize_width",t.width),this._setVariable("resize_height",t.height)},_bindControlButtons:function(){var e=this;t(this.element).find(".picedit_control").bind("click",function(){var i=t(this).data("action");i?e[i](this):t(this).hasClass("picedit_action")&&(t(this).parent(".picedit_element").toggleClass("active").siblings(".picedit_element").removeClass("active"),t(this).parent(".picedit_element").hasClass("active")?t(this).closest(".picedit_nav_box").addClass("active"):t(this).closest(".picedit_nav_box").removeClass("active"))})},_bindInputVariables:function(){var e=this;t(this.element).find(".picedit_input").bind("change keypress paste input",function(){var i=t(this).data("variable");if(i){var a=t(this).val();e._variables[i]=a}if(("resize_width"==i||"resize_height"==i)&&e._variables.resize_proportions){var n=e._image.width/e._image.height;"resize_width"==i?e._setVariable("resize_height",parseInt(a/n,10)):e._setVariable("resize_width",parseInt(a*n,10))}})},_setVariable:function(e,i){this._variables[e]=i,t(this.element).find('[data-variable="'+e+'"]').val(i)}},t.fn[s]=function(e){var i=arguments;if(e===a||"object"==typeof e)return this.each(function(){t.data(this,"plugin_"+s)||t.data(this,"plugin_"+s,new n(this,e))});if("string"==typeof e&&"_"!==e[0]&&"init"!==e){var o;return this.each(function(){var a=t.data(this,"plugin_"+s);a instanceof n&&"function"==typeof a[e]&&(o=a[e].apply(a,Array.prototype.slice.call(i,1))),"destroy"===e&&t.data(this,"plugin_"+s,null)}),o!==a?o:this}}}(jQuery,window,document);